---
- name: Disable snapd and install packages
  hosts: pi
  become: true
  gather_facts: true

  vars:
    packages:
      - name: prometheus-node-exporter
        # renovate: datasource=repology depName=ubuntu_24_04/prometheus-node-exporter versioning=loose
        version: "1.7.0-1ubuntu0.3"
      - name: prometheus-node-exporter-collectors
        # renovate: datasource=repology depName=ubuntu_24_04/prometheus-node-exporter-collectors versioning=loose
        version: "0.0~git20231018.f5c56e7-1"
      - name: net-tools
        # renovate: datasource=repology depName=ubuntu_24_04/net-tools versioning=loose
        version: "2.10-0.1ubuntu4.4"
      - name: unattended-upgrades
        # renovate: datasource=repology depName=ubuntu_24_04/unattended-upgrades versioning=loose
        version: "2.9.1+nmu4ubuntu1"
      - name: apt-listchanges
        # renovate: datasource=repology depName=ubuntu_24_04/apt-listchanges versioning=loose
        version: "3.27"

  tasks:

    - name: Install required packages
      ansible.builtin.package:
        name: "{{ item.name ~ ('=' + item.get('version') if item.get('version') else '') }}"
        state: present
      loop: "{{ packages }}"

    - name: Disable snapd services
      ansible.builtin.systemd_service:
        name: "{{ item }}"
        enabled: false
        state: stopped
        masked: true
      loop:
        - snapd
        - snapd.socket
        - snapd.seeded.service
      ignore_errors: true

    - name: Remove snapd package
      ansible.builtin.apt:
        name: snapd
        state: absent

    - name: Configure periodic APT updates
      ansible.builtin.copy:
        dest: /etc/apt/apt.conf.d/20auto-upgrades
        owner: root
        group: root
        mode: "0644"
        content: |
          APT::Periodic::Update-Package-Lists "1";
          APT::Periodic::Unattended-Upgrade "1";

          Unattended-Upgrade::Allowed-Origins {
              "${distro_id}:${distro_codename}";
              "${distro_id}:${distro_codename}-security";
              "${distro_id}:${distro_codename}-updates";
          //  "${distro_id}:${distro_codename}-proposed";
          //  "${distro_id}:${distro_codename}-backports";
              "${distro_id}ESMApps:${distro_codename}-apps-security";
              "${distro_id}ESM:${distro_codename}-infra-security";
          };

    - name: Ensure unattended-upgrades service is enabled and running
      ansible.builtin.systemd_service:
        name: apt-daily-upgrade.timer
        enabled: true
        state: restarted

- name: Install systemd services
  hosts: pi
  become: true
  gather_facts: true

  vars:
    services:
      - name: otel-collector
        ports:
          '4317': '4317'
          '4318': '4318'

      - name: registry-proxy
        suffix: docker-io
        env:
          REGISTRY_PROXY_REMOTEURL: https://registry-1.docker.io
        ports:
          '15010': '5000'
          '15011': '5001'

      - name: registry-proxy
        suffix: gcr-io
        env:
          REGISTRY_PROXY_REMOTEURL: https://gcr.io
        ports:
          '15020': '5000'
          '15021': '5001'

      - name: registry-proxy
        suffix: ghcr-io
        env:
          REGISTRY_PROXY_REMOTEURL: https://ghcr.io
        ports:
          '15030': '5000'
          '15031': '5001'

      - name: registry-proxy
        suffix: quay-io
        env:
          REGISTRY_PROXY_REMOTEURL: https://quay.io
        ports:
          '15040': '5000'
          '15041': '5001'

      - name: registry-proxy
        suffix: registry-k8s-io
        env:
          REGISTRY_PROXY_REMOTEURL: https://registry.k8s.io
        ports:
          '15050': '5000'
          '15051': '5001'

    configs:
      - src: otel/otelcol-docker.homelab.yaml
        dest: /etc/otelcol/config.yaml
      - src: registry/config.proxy.yml
        dest: /etc/distribution/config.proxy.yml

    # renovate: datasource=docker depName=otel/opentelemetry-collector-k8s
    otel_collector_version: "0.145.0"

    # renovate: datasource=docker depName=registry
    registry_version: "3.0.0"

  roles:
    - geerlingguy.docker

  tasks:

    - name: Ensure destination directories exist
      ansible.builtin.file:
        path: "{{ item.dest | dirname }}"
        state: directory
        owner: root
        group: root
        mode: '0755'
        recurse: yes
      loop: "{{ configs }}"

    - name: Create config files
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../../configs/{{ item.src }}"
        dest: "{{ item.dest }}"
        owner: root
        group: root
        mode: '0644'
        force: true
      loop: "{{ configs }}"

    - name: Create service files
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/rpi5/services/{{ item.name }}.service.j2"
        dest: "/etc/systemd/system/{{ item.name ~ ('-' + item.get('suffix') if item.get('suffix') else '') }}.service"
        owner: root
        group: root
        mode: '0644'
        force: true
      loop: "{{ services }}"

    - name: Enable and start services
      ansible.builtin.systemd_service:
        name: "{{ item.name ~ ('-' + item.get('suffix') if item.get('suffix') else '') }}.service"
        state: restarted
        enabled: true
        masked: false
        daemon_reload: true
      loop: "{{ services }}"

    - name: Weekly Docker volume prune with logging
      ansible.builtin.cron:
        name: "Weekly Docker volume prune"
        user: root
        weekday: "0"            # Sunday
        hour: "3"               # 3:30 AM
        minute: "30"
        job: "/usr/bin/docker volume prune --all --force >> /var/log/docker-prune.log 2>&1"
        state: present

    - name: Weekly Docker system prune with logging
      ansible.builtin.cron:
        name: "Weekly Docker system prune"
        user: root
        weekday: "0"            # Sunday
        hour: "3"               # 3:00 AM
        minute: "0"
        job: "/usr/bin/docker system prune --all --volumes --force >> /var/log/docker-prune.log 2>&1"
        state: present

    - name: Ensure logrotate configuration for Docker prune exists
      ansible.builtin.copy:
        dest: /etc/logrotate.d/docker-prune
        content: |
          /var/log/docker-prune.log {
              weekly
              rotate 4
              compress
              missingok
              notifempty
              create 0640 root root
              postrotate
                  # Optional: reload rsyslog if needed
                  # systemctl reload rsyslog >/dev/null 2>&1 || true
              endscript
          }
        owner: root
        group: root
        mode: '0644'
